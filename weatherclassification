% uncompress the datasets
unzip('wdsets.zip');

% store in imageDatasotre
imds = imageDatastore('wdsets', ...
   'IncludeSubfolders',true, ...
   'LabelSource','foldernames');
   
% Find the first instance of an image for a category and display
rainy = find(imds.Labels == 'rainy', 1);
figure
imshow(readimage(imds,rainy))

% summarize the number of images per category
tbl = countEachLabel(imds)

% Limit the number of images
maxNumImages = 100;

% Trim the set
imds = splitEachLabel(imds, maxNumImages, 'randomize');

% summarize the trimmed number of images per category
countEachLabel(imds)

% Load pretrained network
net = resnet50();

% display the first section of the network
figure
plot(net)
title('First section of ResNet-50')
set(gca,'YLim',[150 170]);

% Inspect the first layer
net.Layers(1)

% Inspect the last layer
net.Layers(end)

% Dipslay the number of class names for ImageNet classification task
numel(net.Layers(end).ClassNames)

% Split the sets into training and validation data
[trainingSet, testSet] = splitEachLabel(imds, 0.3, 'randomize');

% Resize images
imageSize = net.Layers(1).InputSize;
augmentedTrainingSet = augmentedImageDatastore(imageSize, trainingSet, 'ColorPreprocessing', 'gray2rgb');
augmentedTestSet = augmentedImageDatastore(imageSize, testSet, 'ColorPreprocessing', 'gray2rgb');

% Get the network weights for the second convolutional layer
w1 = net.Layers(2).Weights;

% Scale and resize the weights for visualization
w1 = mat2gray(w1);
w1 = imresize(w1,5);

% Display a montage of network weights
figure
montage(w1)
title('First convolutional layer weights')
featureLayer = 'fc1000';
trainingFeatures = activations(net, augmentedTrainingSet, featureLayer, ...
   'MiniBatchSize', 32, 'OutputAs', 'columns');
   
% Get training labels from the trainingSet
trainingLabels = trainingSet.Labels;

% Train multiclass SVM classifier using a fast linear solver
classifier = fitcecoc(trainingFeatures, trainingLabels, ...
   'Learners', 'Linear', 'Coding', 'onevsall', 'ObservationsIn', 'columns');
   
% Extract test features using the CNN
testFeatures = activations(net, augmentedTestSet, featureLayer, ...
   'MiniBatchSize', 32, 'OutputAs', 'columns');
   
% Pass CNN image features to trained classifier
predictedLabels = predict(classifier, testFeatures, 'ObservationsIn', 'columns');
testLabels = testSet.Labels;
confMat = confusionmat(testLabels, predictedLabels);
confMat = bsxfun(@rdivide,confMat,sum(confMat,2))
mean(diag(confMat))
[n, d] = uigetfile();
f = fullfile(d,n); 
testImage = imread(f);
b = dec2bin(p,8) - '0';
ds = augmentedImageDatastore(imageSize, testImage, 'ColorPreprocessing', 'gray2rgb');
imageFeatures = activations(net, ds, featureLayer, 'OutputAs', 'columns');
predictedLabel = predict(classifier, imageFeatures, 'ObservationsIn', 'columns')
